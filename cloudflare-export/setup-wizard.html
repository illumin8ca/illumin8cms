<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Illumin8 Cloudflare Launcher</title>
    <link rel="icon" type="image/svg+xml" href="https://illumin8.ca/wp-content/uploads/2023/10/flate-icon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .logo {
            height: 50px;
            width: auto;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Remove default bullets in info list */
        #step3 .info-box ul {
            list-style: none;
            padding-left: 0;
        }
        #step3 .info-box li { margin-bottom: 6px; }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #e0e0e0;
        }

        .status-item.success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .status-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .status-item.loading {
            border-left-color: #667eea;
            background: #e3f2fd;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e0e0e0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-icon {
            color: #28a745;
            margin-right: 10px;
            font-size: 18px;
        }

        .error-icon {
            color: #dc3545;
            margin-right: 10px;
            font-size: 18px;
        }

        .final-step {
            text-align: center;
        }

        .final-step h2 {
            color: #28a745;
            margin-bottom: 20px;
        }

        .website-link {
            display: inline-block;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }

        .website-link:hover {
            transform: translateY(-2px);
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        html body div.container div.content div#step1.step.active div.info-box {
            margin-top: 25px;
        }

        /* Margin for final info-box */
        html body div.container div.content div#step3.step.active div.final-step div.info-box {
            margin-top: 25px;
        }

        /* Add spacing in progress step */
        html body div.container div.content div#step2.step.active div#statusContainer {
            margin-top: 25px;
        }
        html body div.container div.content div#step1.step.active div#wranglerLoginDiv div.info-box button#wranglerLoginBtn.btn {
            margin-top: 25px;
        }
        #wranglerContinueBtn {
            margin-top: 25px;
        }
        #cnameCheckboxContainer input[type='checkbox'] {
          width: auto !important;
          padding: 0 !important;
          border-radius: 4px;
          vertical-align: middle;
        }
        #cnameCheckboxContainer div label {
          margin-bottom: 0 !important;
        }
        #accountGroup {
          position: relative;
        }
        #accountSuggestions {
          position: absolute;
          left: 0;
          right: 0;
          top: 80px;
          z-index: 10;
          background: white;
          border: 2px solid #e0e0e0;
          border-top: none;
          border-radius: 10px 10px 10px 10px;
          list-style: none;
          margin: 0;
          padding: 0;
          max-height: 180px;
          overflow-y: auto;
          box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }
        #accountSuggestions li {
          padding: 10px;
          cursor: pointer;
        }
        #accountSuggestions li:hover {
          background: #f5f5f5;
        }
        #accountSuggestions {
          border: none;
          border-radius: 10px;
          transition: border 0.2s, border-radius 0.2s;
        }
        #accountSuggestions.active {
          border: 2px solid #e0e0e0;
          border-top: none;
          border-radius: 0 0 10px 10px;
        }
        #accountSearch {
          box-shadow: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://illumin8.ca/wp-content/uploads/2023/10/illumin8-footer-logo.svg" alt="Illumin8 Logo" class="logo" style="padding: 10px; border-radius: 10px; height: 50px; width: auto;" onerror="this.style.display='none';">
                <span style="font-size: 2rem;">√ó</span>
                <img src="logo-cloudflare.png" alt="Cloudflare Logo" class="logo" style="padding: 10px; border-radius: 10px; height: 50px; width: auto;" onerror="this.style.display='none';">
            </div>
            <h1>Cloudflare Launcher</h1>
            <p>Automated setup for Scenic Valley Quilting</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Step 1: Credentials -->
            <div class="step active" id="step1">
                <h2>üîê Authentication Setup</h2>
                <div class="info-box">
                    <h4>What we‚Äôll do:</h4>
                    <p>1Ô∏è‚É£ Create a one-time Cloudflare API token (scoped to this account only).<br/>
                       2Ô∏è‚É£ Build & deploy your storefront and admin dashboard.<br/>
                       3Ô∏è‚É£ Provision database and Zero-Trust Access.<br/>
                       4Ô∏è‚É£ Optionally set up your custom domain & DNS.</p>
                    <p style="margin-top:10px;">Just provide your Global API Key (or let the wizard pick it up from <code>.env</code>) and choose the Cloudflare <strong>Account</strong> you want to use.</p>
                </div>
                
                <div class="form-group">
                    <label for="email">Cloudflare Email:</label>
                    <input type="email" id="email" value="admin@illumin8.ca" required>
                </div>
                
                <div class="form-group">
                    <label for="globalKey">Global API Key:</label>
                    <input type="password" id="globalKey" placeholder="Enter your Global API Key" required>
                </div>

                <div class="form-group" id="accountGroup">
                    <label for="accountSearch">Cloudflare Account:</label>
                    <input id="accountSearch" type="text" placeholder="Start typing your account name..." autocomplete="off" style="width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;" />
                    <ul id="accountSuggestions" style="list-style:none;margin:0;padding:0;max-height:180px;overflow-y:auto;"></ul>
                </div>
                
                <div class="form-group">
                    <label for="additionalEmail">Additional Admin Email (optional):</label>
                    <input type="email" id="additionalEmail" placeholder="e.g., client@example.com">
                </div>

                <div class="form-group" id="domainGroup">
                    <label for="customDomain">Deployment Domain:</label>
                    <select id="customDomain" style="width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;background-color:white;"></select>
                    <div id="cnameCheckboxContainer" style="margin-top:10px;">
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" id="createCnameCheckbox" style="margin-right:8px;">
                            <label for="createCnameCheckbox" style="font-weight:normal; font-size:15px;">Create CNAME entries for this domain</label>
                        </div>
                    </div>
                </div>
                
                <button class="btn" id="startBtn" onclick="startSetup()" disabled>üöÄ Start Setup</button>
            </div>

            <!-- Step 2: Progress -->
            <div class="step" id="step2">
                <h2>‚öôÔ∏è Setting Up Your Site</h2>
                <div id="statusContainer">
                    <!-- Status items will be added here dynamically -->
                </div>
            </div>

            <!-- Step 3: Complete -->
            <div class="step" id="step3">
                <div class="final-step">
                    <h2>üéâ Setup Complete!</h2>
                    <p>Your Scenic Valley Quilting website is now live and ready!</p>
                    
                    <div class="info-box">
                        <h4>What was configured:</h4>
                        <ul style="text-align: left; margin-top: 10px;">
                            <li>‚úÖ Frontend and Admin builds</li>
                            <li>‚úÖ Database schema and seed data</li>
                            <li>‚úÖ Cloudflare Access protection for /admin</li>
                            <li>‚úÖ Admin permissions for specified emails</li>
                        </ul>
                    </div>
                    
                    <a href="#" class="website-link" id="websiteLink" target="_blank">
                        üåê Visit Your Website
                    </a>
                    
                    <div style="margin-top: 30px;">
                        <p style="color: #666; font-size: 14px;">
                            Powered by <strong>Illumin8 Digital Marketing</strong><br>
                            <a href="https://illumin8.ca" target="_blank" style="color: #667eea;">illumin8.ca</a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Step 4: Enable Access -->
            <div class="step" id="enableAccessStep">
                <div style="text-align:center;">
                    <img src="/enable-access.svg" alt="Enable Access" style="width:64px;height:64px;margin-bottom:20px;"/>
                    <h2 style="color:#667eea;">Enable Cloudflare Access</h2>
                    <p style="margin:20px 0;">Cloudflare Access (Zero Trust) is not enabled for this account.<br>
                    <b>To continue, you must enable Access in your Cloudflare dashboard.</b></p>
                    <ol style="text-align:left;max-width:400px;margin:0 auto 20px auto;">
                        <li>Click the button below to open the Cloudflare Access dashboard.</li>
                        <li>Click <b>"Enable Access"</b> or <b>"Get Started"</b> in the dashboard.</li>
                        <li>Return here and click <b>Resume Setup</b>.</li>
                    </ol>
                    <a id="openAccessDashboard" class="btn" href="#" target="_blank" style="margin-bottom:16px;display:inline-block;width:auto;">Open Cloudflare Access Dashboard</a><br>
                    <button class="btn" id="resumeAccessBtn" style="width:auto;">Resume Setup</button>
                </div>
            </div>

            <!-- Step 5: Enable R2 -->
            <div class="step" id="enableR2Step">
                <div style="text-align:center;">
                    <div style="width:64px;height:64px;margin:0 auto 20px auto;background:#667eea;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;">‚òÅÔ∏è</div>
                    <h2 style="color:#667eea;">Enable R2 Object Storage</h2>
                    <p style="margin:20px 0;">Cloudflare R2 Object Storage is not enabled for this account.<br>
                    <b>To continue, you must enable R2 in your Cloudflare dashboard.</b></p>
                    <ol style="text-align:left;max-width:400px;margin:0 auto 20px auto;">
                        <li>Click the button below to open the Cloudflare R2 dashboard.</li>
                        <li>Click <b>"Enable R2"</b> and follow the setup process.</li>
                        <li>Return here and click <b>Resume Setup</b>.</li>
                    </ol>
                    <a id="openR2Dashboard" class="btn" href="#" target="_blank" style="margin-bottom:16px;display:inline-block;width:auto;">Open Cloudflare R2 Dashboard</a><br>
                    <button class="btn" id="resumeR2Btn" style="width:auto;">Resume Setup</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 4;
        let selectedAccountId = null;
        let accountsList = [];
        let selectedAccountName = '';

        // Auto-fill credentials from backend env (if provided)
        (async function initFromEnv() {
            try {
                const res = await fetch('/api/env');
                if (!res.ok) return;
                const data = await res.json();
                if (data && data.globalKey) {
                    const cleanEmail = (data.email || '').split('=')[ (data.email||'').split('=').length -1 ];
                    document.getElementById('email').value = cleanEmail;
                    // Hide email field group
                    const emailGroup = document.querySelector('label[for="email"]').parentElement;
                    
                    document.getElementById('globalKey').value = data.globalKey;
                    // Hide global key field completely
                    const keyGroup = document.querySelector('label[for="globalKey"]').parentElement;
                    
                    // Immediately trigger blur to fetch accounts list
                    document.getElementById('globalKey').dispatchEvent(new Event('blur'));
                }
            } catch (err) {
                console.warn('No env credentials found or failed to fetch /api/env');
            }
        })();

        document.addEventListener('DOMContentLoaded', function() {
          document.getElementById('domainGroup').style.display = 'none';
        });

        function updateProgress() {
            let progress;
            if (currentStep === 3) {
                progress = 100;
            } else {
                progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            }
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            updateProgress();
        }

        // Patch: Fetch accounts after entering email and key
        const globalKeyInput = document.getElementById('globalKey');
        globalKeyInput.addEventListener('blur', async function() {
            const email = document.getElementById('email').value;
            const globalKey = document.getElementById('globalKey').value;
            if (!email || !globalKey) return;
            document.getElementById('startBtn').disabled = true;
            const searchInput = document.getElementById('accountSearch');
            const suggestions = document.getElementById('accountSuggestions');
            searchInput.value = '';
            suggestions.innerHTML = '';
            try {
                const response = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, globalKey })
                });
                const result = await response.json();
                if (!response.ok || !result.accounts || !result.accounts.length) throw new Error(result.error || 'No accounts found');
                accountsList = result.accounts;
                document.getElementById('accountGroup').style.display = 'block';
                selectedAccountId = null;
                selectedAccountName = '';
                document.getElementById('startBtn').disabled = true;
            } catch (err) {
                suggestions.innerHTML = '<li style="padding:10px;color:#dc3545;">Error loading accounts</li>';
                suggestions.style.display = 'block';
                suggestions.classList.add('active');
                document.getElementById('accountGroup').style.display = 'block';
                document.getElementById('startBtn').disabled = true;
            }
        });

        // Auto-complete logic
        document.getElementById('accountSearch').addEventListener('input', function() {
            const val = this.value.toLowerCase();
            const suggestions = document.getElementById('accountSuggestions');

            const matches = accountsList.filter(acc => acc.name.toLowerCase().includes(val));
            if (!matches.length) {
                suggestions.innerHTML = '<li style="padding:10px;color:#dc3545;">No matching accounts</li>';
                suggestions.style.display = 'block';
                suggestions.classList.add('active');
                selectedAccountId = null;
                selectedAccountName = '';
                document.getElementById('startBtn').disabled = true;
                return;
            }
            suggestions.innerHTML = matches.map(acc => `<li data-id="${acc.id}" style="padding:10px;cursor:pointer;">${acc.name}</li>`).join('');
            suggestions.style.display = 'block';
            suggestions.classList.add('active');
        });
        document.getElementById('accountSuggestions').addEventListener('mousedown', function(e) {
            if (e.target.tagName === 'LI' && e.target.dataset.id) {
                selectedAccountId = e.target.dataset.id;
                selectedAccountName = e.target.textContent;
                document.getElementById('accountSearch').value = selectedAccountName;
                this.style.display = 'none';
                this.classList.remove('active');
                fetchAndPopulateZones(selectedAccountId);
                document.getElementById('domainGroup').style.display = 'block';
                document.getElementById('startBtn').disabled = false;
            }
        });

        function addStatus(message, type = 'loading') {
            const container = document.getElementById('statusContainer');
            const statusItem = document.createElement('div');
            statusItem.className = `status-item ${type}`;
            
            let icon = '';
            if (type === 'loading') {
                icon = '<div class="spinner"></div>';
            } else if (type === 'success') {
                icon = '<span class="success-icon">‚úÖ</span>';
            } else if (type === 'error') {
                icon = '<span class="error-icon">‚ùå</span>';
            }
            
            statusItem.innerHTML = icon + message;
            container.appendChild(statusItem);
            
            return statusItem;
        }

        async function startSetup() {
            const email = document.getElementById('email').value;
            const globalKey = document.getElementById('globalKey').value;
            const additionalEmail = document.getElementById('additionalEmail').value;
            const customDomainValue = document.getElementById('customDomain').value;
            const createCnameCheckbox = document.getElementById('createCnameCheckbox');
            const accountId = selectedAccountId;
            if (!email || !globalKey || !accountId) {
                alert('Please fill in all required fields and select an account');
                return;
            }
            showStep(2);
            
            try {
                // Step 1: Get account info
                let status = addStatus('Getting account information...', 'loading');
                const accountId = await getAccountId(email, globalKey);
                const accountInput = document.getElementById('accountSearch');
                accountInput.value = accountId;
                accountInput.readOnly = false;
                accountInput.style.backgroundColor = 'white';
                accountInput.style.color = '#222';
                status.className = 'status-item success';
                status.innerHTML = '<span class="success-icon">‚úÖ</span>Account ID retrieved: ' + accountId;
                
                // Step 2: Create API token
                status = addStatus('Creating scoped API token...', 'loading');
                const apiToken = await createApiToken(email, globalKey, accountId);
                status.className = 'status-item success';
                status.innerHTML = '<span class="success-icon">‚úÖ</span>API token created successfully';
                
                // Step 3: Build frontend
                status = addStatus('Building storefront...', 'loading');
                await runCommand('npm --prefix frontend run build');
                status.className = 'status-item success';
                status.innerHTML = '<span class="success-icon">‚úÖ</span>Storefront built successfully';
                
                // Step 4: Build admin
                status = addStatus('Building admin dashboard...', 'loading');
                await runCommand('npm --prefix frontend-admin run build');
                status.className = 'status-item success';
                status.innerHTML = '<span class="success-icon">‚úÖ</span>Admin dashboard built successfully';
                
                // Step 5: Setup database
                status = addStatus('Setting up database...', 'loading');
                await runCommand('wrangler d1 execute scenic-valley-quilts --local --file ./db/schema.sql');
                await runCommand('wrangler d1 execute scenic-valley-quilts --local --file ./db/seed.sql');
                status.className = 'status-item success';
                status.innerHTML = '<span class="success-icon">‚úÖ</span>Database configured and seeded';
                
                // Step 6: Configure Access
                status = addStatus('Configuring Cloudflare Access...', 'loading');
                const adminEmails = ['admin@illumin8.ca'];
                if (additionalEmail) {
                    adminEmails.push(additionalEmail);
                }
                await configureAccess(apiToken, accountId, adminEmails);
                status.className = 'status-item success';
                status.innerHTML = '<span class="success-icon">‚úÖ</span>Cloudflare Access configured';
                
                const isProdDomain = customDomainValue && !customDomainValue.includes('.pages.dev');
                const shouldCreateCname = isProdDomain && createCnameCheckbox && createCnameCheckbox.checked;
                
                // Step 7: Deploy to Cloudflare Pages
                const projectName = 'scenic-valley-quilting';
                const distPath = './frontend/dist';
                const domainForDeploy = isProdDomain ? customDomainValue : null;
                
                // Check if project exists first
                const projectCheck = await checkProjectExists(apiToken, accountId, projectName);
                const isNewProject = !projectCheck.exists;
                
                const deployMessage = isNewProject ? 'Creating and deploying new website...' : 'Updating existing website...';
                status = addStatus(deployMessage, 'loading');
                
                const deployResult = await deployToCloudflare(apiToken, accountId, projectName, distPath, domainForDeploy);
                status.className = 'status-item success';
                
                const successMessage = isNewProject ? 'New website created and deployed successfully' : 'Website updated successfully';
                status.innerHTML = `<span class="success-icon">‚úÖ</span>${successMessage}`;

                // Optional: add CNAME records
                let dnsSuccess = true;
                let dnsManualRoot = false;
                let dnsErrorMsg = '';
                if (shouldCreateCname) {
                    status = addStatus('Adding DNS records...', 'loading');
                    try {
                        const dnsResult = await addDnsRecords(apiToken, customDomainValue, `${projectName}.pages.dev`);
                        status.className = 'status-item success';
                        status.innerHTML = '<span class="success-icon">‚úÖ</span>DNS records added';
                        if (dnsResult.manualRoot) dnsManualRoot = true;
                    } catch (err) {
                        status.className = 'status-item error';
                        status.innerHTML = '<span class="error-icon">‚ùå</span>Failed to add DNS records: ' + (err.message || err);
                        dnsSuccess = false;
                        dnsErrorMsg = err.message || err;
                    }
                }
                // Complete
                setTimeout(() => {
                    if (!dnsSuccess) {
                        // Show error and do not advance
                        addStatus('Setup incomplete: DNS records could not be created. Please add them manually in the Cloudflare dashboard.', 'error');
                        // Always show dev link for manual setup
                        const finalStepElement = document.querySelector('#step3 .final-step');
                        if (finalStepElement) {
                            finalStepElement.innerHTML = `
                                <h2>‚ö†Ô∏è Manual DNS Setup Required</h2>
                                <p>DNS records could not be created automatically.<br>
                                Please add a CNAME for <b>www.${customDomainValue}</b> pointing to <b>${projectName}.pages.dev</b> in your Cloudflare dashboard.</p>
                                <p>Your site is live at:</p>
                                <a id="websiteLink" href="https://${projectName}.pages.dev" target="_blank" class="website-link">https://${projectName}.pages.dev</a>
                                <div style="margin-top:30px;color:#666;font-size:14px;">Powered by <strong>Illumin8 Digital Marketing</strong><br><a href="https://illumin8.ca" target="_blank" style="color:#667eea;">illumin8.ca</a></div>
                            `;
                        }
                        showStep(3);
                        return;
                    }
                    showStep(3);
                    document.getElementById('websiteLink').href = deployResult.url;
                    // Update the success message with deployment details
                    const deploymentType = deployResult.deploymentType || (isNewProject ? 'fresh' : 'update');
                    const deploymentText = deploymentType === 'fresh' ? 'Fresh deployment' : 'Update deployment';
                    const finalStepElement = document.querySelector('#step3 .final-step');
                    if (finalStepElement) {
                        let manualRootMsg = dnsManualRoot ? `<div style='color:#b58900;margin:12px 0 0 0;'>You may need to manually configure the root domain (<b>${customDomainValue}</b>) in Cloudflare. Only <b>www.${customDomainValue}</b> was set up automatically.</div>` : '';
                        finalStepElement.innerHTML = `
                            <h2>üéâ Setup Complete!</h2>
                            <p><strong>${deploymentText}</strong> of Scenic Valley Quilting website completed successfully.</p>
                            <p>Your website is now live at:</p>
                            <a id="websiteLink" href="${deployResult.url}" target="_blank" class="website-link">${deployResult.url}</a>
                            <div style="margin-top:10px;">Cloudflare Pages dev link: <a href="https://${projectName}.pages.dev" target="_blank">https://${projectName}.pages.dev</a></div>
                            ${manualRootMsg}
                            <div style="margin-top:30px;color:#666;font-size:14px;">Powered by <strong>Illumin8 Digital Marketing</strong><br><a href="https://illumin8.ca" target="_blank" style="color:#667eea;">illumin8.ca</a></div>
                        `;
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Setup failed:', error);
                addStatus('Setup failed: ' + error.message, 'error');
            }
        }

        async function getAccountId(email, globalKey) {
            // Deprecated: now using account selection
            return selectedAccountId;
        }

        async function createApiToken(email, globalKey, accountId) {
            const response = await fetch('/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    globalKey: globalKey,
                    accountId: accountId
                })
            });
            
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'Failed to create API token');
            }
            
            return result.token;
        }

        async function runCommand(command) {
            const response = await fetch('/api/build', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: command
                })
            });
            
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'Failed to execute command');
            }
            
            return result;
        }

        async function configureAccess(apiToken, accountId, adminEmails) {
            const response = await fetch('/api/access', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiToken: apiToken,
                    accountId: accountId,
                    adminEmails: adminEmails
                })
            });
            
            const result = await response.json();
            if (!response.ok) {
                // Special handling for Access not enabled
                if (result.details && Array.isArray(result.details) && result.details.some(e => (e.message||'').includes('access.api.error.not_enabled'))) {
                    showEnableAccessStep(accountId, apiToken, adminEmails);
                    throw new Error('Cloudflare Access is not enabled. Please enable it and resume.');
                }
                throw new Error(result.error || 'Failed to configure Cloudflare Access');
            }
            
            return result;
        }

        async function checkProjectExists(apiToken, accountId, projectName) {
            const response = await fetch('/api/pages/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiToken: apiToken,
                    accountId: accountId,
                    projectName
                })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'Failed to check project status');
            }

            return result;
        }

        async function deployToCloudflare(apiToken, accountId, projectName, distPath, customDomain) {
            const response = await fetch('/api/pages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiToken: apiToken,
                    accountId: accountId,
                    projectName,
                    distPath,
                    customDomain
                })
            });

            const result = await response.json();
            if (!response.ok) {
                // Special handling for R2 not enabled
                if (result.error === 'R2 Storage is not enabled' && result.instructions) {
                    showEnableR2Step(accountId, apiToken, projectName, distPath, customDomain);
                    throw new Error('R2 Storage is not enabled. Please enable it and resume.');
                }
                throw new Error(result.error || 'Failed to deploy to Cloudflare Pages');
            }

            return result;
        }

        async function addDnsRecords(apiToken, zoneName, target) {
            const response = await fetch('/api/dns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apiToken, zoneName, target })
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'Failed to add DNS records');
            }
            return result;
        }

        async function fetchAndPopulateZones(accountId) {
            const domainGroup = document.getElementById('domainGroup');
            const domainSelect = document.getElementById('customDomain');
            const cnameCheckboxContainer = document.getElementById('cnameCheckboxContainer');
            const createCnameCheckbox = document.getElementById('createCnameCheckbox');
            domainGroup.style.display = 'block';
            domainSelect.innerHTML = '<option>Loading domains...</option>';
            domainSelect.disabled = true;

            const email = document.getElementById('email').value;
            const globalKey = document.getElementById('globalKey').value;
            const projectName = 'scenic-valley-quilting';

            try {
                let body;
                body = JSON.stringify({ email, globalKey, accountId });
                const response = await fetch('/api/zones', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body
                });
                const result = await response.json();
                if (!response.ok || !result.zones) throw new Error(result.error || 'Failed to load domains');
                
                domainSelect.innerHTML = ''; // Clear loading message

                // Add production domains
                result.zones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone.name;
                    option.textContent = zone.name;
                    domainSelect.appendChild(option);
                });

                // Add development option
                const devOption = document.createElement('option');
                const devUrl = `${projectName}.pages.dev`;
                devOption.value = devUrl;
                devOption.textContent = `${devUrl} (Development)`;
                domainSelect.appendChild(devOption);
                
                domainSelect.disabled = false;

            } catch (err) {
                domainSelect.innerHTML = `<option value="">Error: ${err.message}</option>`;
            }
        }

        async function fetchAndPopulateAccounts() {
            console.log('useWranglerLogin', useWranglerLogin);
            const accountGroup = document.getElementById('accountGroup');
            const searchInput = document.getElementById('accountSearch');
            const suggestions = document.getElementById('accountSuggestions');
            accountGroup.style.display = 'block';
            searchInput.value = '';
            suggestions.innerHTML = '';
            try {
                let body;
                const email = document.getElementById('email').value;
                const globalKey = document.getElementById('globalKey').value;
                body = JSON.stringify({ email, globalKey });
                const response = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body
                });
                const result = await response.json();
                if (!response.ok || !result.accounts || !result.accounts.length) throw new Error(result.error || 'No accounts found');
                accountsList = result.accounts;
                if (result.email) {
                    const emailInput = document.getElementById('email');
                    emailInput.value = result.email;
                    emailInput.disabled = true;
                }
                accountGroup.style.display = 'block';
                selectedAccountId = null;
                selectedAccountName = '';
                document.getElementById('startBtn').disabled = true;
            } catch (err) {
                suggestions.innerHTML = `<li style="padding:10px;color:#dc3545;">Error loading accounts: ${err.message || err}</li>`;
                suggestions.style.display = 'block';
                suggestions.classList.add('active');
                accountGroup.style.display = 'block';
                document.getElementById('startBtn').disabled = true;
            }
        }

        function showEnableAccessStep(accountId, apiToken, adminEmails) {
            // Hide progress and show enable access step
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('enableAccessStep').classList.add('active');
            // Set dashboard link
            const accessLink = `https://dash.cloudflare.com/?to=/:accountId/access`.replace(':accountId', accountId);
            document.getElementById('openAccessDashboard').href = accessLink;
            // Resume button logic
            document.getElementById('resumeAccessBtn').onclick = async function() {
                // Show progress again
                showStep(2);
                let status = addStatus('Re-checking Cloudflare Access...', 'loading');
                try {
                    await configureAccess(apiToken, accountId, adminEmails);
                    status.className = 'status-item success';
                    status.innerHTML = '<span class="success-icon">‚úÖ</span>Cloudflare Access enabled and configured!';
                    // Continue setup
                    setTimeout(() => {
                        setStatus('Deploying to Cloudflare...');
                        deployToCloudflare();
                    }, 1000);
                } catch (err) {
                    status.className = 'status-item error';
                    status.innerHTML = '<span class="error-icon">‚ùå</span>' + (err.message || 'Failed to configure Access');
                }
            };
        }

        function showEnableR2Step(accountId, apiToken, projectName, distPath, customDomain) {
            // Hide progress and show enable R2 step
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('enableR2Step').classList.add('active');
            // Set dashboard link
            const r2Link = `https://dash.cloudflare.com/?to=/:accountId/r2`.replace(':accountId', accountId);
            document.getElementById('openR2Dashboard').href = r2Link;
            // Resume button logic
            document.getElementById('resumeR2Btn').onclick = async function() {
                // Show progress again
                showStep(2);
                let status = addStatus('Re-checking R2 Storage...', 'loading');
                try {
                    const deployResult = await deployToCloudflare(apiToken, accountId, projectName, distPath, customDomain);
                    status.className = 'status-item success';
                    status.innerHTML = '<span class="success-icon">‚úÖ</span>R2 Storage enabled and deployment successful!';
                    // Continue with DNS setup if needed
                    setTimeout(() => {
                        // Continue with the rest of the setup process
                        const finalStepElement = document.querySelector('#step3 .final-step');
                        if (finalStepElement) {
                            finalStepElement.innerHTML = `
                                <h2>üéâ Setup Complete!</h2>
                                <p>Your Scenic Valley Quilting website is now live and ready!</p>
                                <a id="websiteLink" href="${deployResult.url}" target="_blank" class="website-link">${deployResult.url}</a>
                                <div style="margin-top:30px;color:#666;font-size:14px;">Powered by <strong>Illumin8 Digital Marketing</strong><br><a href="https://illumin8.ca" target="_blank" style="color:#667eea;">illumin8.ca</a></div>
                            `;
                        }
                        showStep(3);
                    }, 1000);
                } catch (err) {
                    status.className = 'status-item error';
                    status.innerHTML = '<span class="error-icon">‚ùå</span>' + (err.message || 'Failed to enable R2 Storage');
                }
            };
        }

        // Initialize
        updateProgress();
    </script>
</body>
</html> 